/* @settings
   (保持原有 @settings 块内容不变，为了简洁这里不重复列出)
*/

body {
    /* === Global Variables === */
    --pwc-font-size: 14px;
    --pwc-tooltip-font-size: 14px;
    --pwc-citation-underline-color: var(--text-accent);
    --pwc-citation-underline-color-missing: transparent;
    --pwc-citation-extra-color: var(--text-normal);
    --pwc-citation-formatting-color: var(--text-normal);
    --pwc-citation-color: var(--text-normal);
    --pwc-citation-color-missing: var(--text-normal);
}

/* ============================================================
   SECTION 1: Bibliography List (Sidebar View)
   ============================================================ */

.pwc-reference-list { padding-bottom: 2rem; }

.pwc-reference-list__title {
    font-size: var(--pwc-font-size);
    font-weight: bold;
    padding: 0 5px;
    display: flex; justify-content: space-between; align-items: center;
}

.pwc-reference-list__title > div { display: flex; align-items: center; gap: var(--size-4-1); }

.pwc-reference-list__count {
    color: var(--text-muted);
    display: flex; padding: var(--size-4-1) var(--size-4-2);
    border-radius: var(--tag-radius);
    background-color: rgba(var(--mono-rgb-100), 0.05);
    font-weight: var(--font-normal);
    line-height: 1; font-size: var(--font-ui-smaller);
}

.pwc-no-content { font-size: var(--pwc-font-size); padding: 0 5px; color: var(--text-muted); }

.csl-entry-wrapper {
    --icon-size: var(--icon-s); --icon-stroke: var(--icon-s-stroke-width);
    display: flex; padding: 1em 5px; gap: var(--size-4-2);
}

.pwc-reference-list .csl-entry-wrapper:not(:last-child) { border-bottom: 1px solid var(--background-modifier-border); }

.csl-entry { font-size: var(--pwc-font-size); word-wrap: break-word; gap: var(--size-4-2); }
.csl-entry:has(> div + div) { display: flex; }
.pwc-entry-btns { display: flex; flex-direction: column; gap: var(--size-4-1); }
.pwc-reference-list a.footnote-ref { vertical-align: super; }
.pwc-reference-list em, .pwc-reference-list em em em { font-style: italic; }
.pwc-reference-list em em { font-style: normal; }
.pwc-reference-list code { white-space: pre-wrap; }
.pwc-reference-list span.smallcaps { font-variant: small-caps; }
.pwc-reference-list span.underline { text-decoration: underline; }
.pwc-reference-list q { quotes: '“' '”' '‘' '’'; }
.pwc-reference-list div.column { display: inline-block; vertical-align: top; width: 50%; }

/* Collapsed Links Mode */
.pwc-tooltip.collapsed-links a, .pwc-reference-list.collapsed-links a { font-size: 0; }
.pwc-tooltip.collapsed-links a::after, .pwc-reference-list.collapsed-links a::after {
    font-size: var(--pwc-font-size); content: ' '; display: inline-block; width: 1em; height: 1em;
    background-color: var(--text-accent);
    mask-image: url("data:image/svg+xml,..."); /* (保持原有的SVG) */
    -webkit-mask-image: url("data:image/svg+xml,...");
}

/* ============================================================
   SECTION 2: Tooltips & Editor Highlights
   ============================================================ */

.pwc-tooltip {
    word-wrap: break-word; position: fixed; font-family: var(--font-interface); font-size: var(--pwc-tooltip-font-size);
    padding: 10px; background-color: var(--background-primary); border: 1px solid var(--background-modifier-border);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-radius: 6px; width: 95vw; max-width: 300px;
    line-height: 1.4; z-index: var(--layer-popover); overflow: hidden; display: flex; flex-direction: column;
    gap: var(--size-4-2); user-select: text;
}
.pwc-tooltip .csl-entry { padding: 0; }
.pwc-tooltip .csl-entry-wrapper { padding: 0; }

.pwc-tooltips .cm-hmd-barelink { text-decoration: none; }
.pwc-tooltips :not(a, .cm-hmd-internal-link, .cm-link-alias) > :is(.pandoc-citation, .at).is-resolved { color: var(--pwc-citation-color); }
.pwc-tooltips :not(.cm-formatting-link) > .cm-pandoc-citation-formatting:not(.at) { color: var(--pwc-citation-formatting-color); }
.pwc-tooltips :not(.cm-hmd-internal-link, .cm-link-alias) > .cm-pandoc-citation-extra { color: var(--pwc-citation-extra-color); }

.pwc-tooltips :not(.cm-link-alias) > :is(.pandoc-citation, .at).is-resolved {
    text-decoration: underline; text-decoration-style: dotted; text-decoration-thickness: 2px; text-decoration-color: var(--pwc-citation-underline-color);
}
.pwc-tooltips :not(.cm-hmd-internal-link, .cm-link-alias) > :is(.pandoc-citation, .at).is-unresolved {
    text-decoration-color: var(--pwc-citation-underline-color-missing); opacity: 1; color: var(--pwc-citation-color-missing);
}

.pandoc-citation > * { pointer-events: none; }
.pwc-success { color: var(--interactive-success); }
.pwc-error { color: var(--text-error); }

/* ============================================================
   SECTION 3: Settings UI Helpers
   ============================================================ */

.pwc-multiselect { width: 320px; text-align: left; font-size: var(--font-ui-small); }
.pwc-multiselect input { outline: none !important; box-shadow: none !important; font-size: var(--font-ui-small); height: unset; }
.pwc-setting-item-wrapper { flex-direction: column; align-items: stretch; }
.pwc-setting-item-wrapper > div { margin-right: 0 !important; }
.pwc-group-toggle { display: flex; justify-content: flex-end; padding-top: var(--size-4-2); }
.pwc-suggest-title { font-size: var(--font-ui-small); color: var(--text-muted); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-top: var(--size-4-1); }

/* Loading Spinner */
.pwc-suggest-loading-wrapper { display: flex; position: relative; align-items: center; justify-content: center; padding: var(--size-4-2) 0; }
.pwc-suggest-loading, .pwc-suggest-loading:before, .pwc-suggest-loading:after {
    border-radius: 999px; width: 1em; height: 1em; animation-fill-mode: both; animation: bblFadInOut 1.6s infinite ease-in-out;
}
.pwc-suggest-loading { display: block; color: var(--text-muted); font-size: 7px; position: relative; animation-delay: -0.16s; top: -1em; }
.pwc-suggest-loading:before { content: ''; position: absolute; left: -2em; animation-delay: -0.32s; }
.pwc-suggest-loading:after { content: ''; position: absolute; left: 2em; }
@keyframes bblFadInOut { 0%, 80%, 100% { box-shadow: 0 1em 0 -1.3em; } 40% { box-shadow: 0 1em 0 0; } }

/* Status Bar */
.pwc-status-icon { --icon-size: var(--icon-s); --icon-stroke: var(--icon-s-stroke-width); }
.pwc-status-icon.is-loading svg { animation: spin 2s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Suggestion Box */
.suggestion-container.pwc-suggest { max-width: 500px; width: 95vw; }

/* ============================================================
   SECTION 4: Figure & Table Live Preview (Core)
   ============================================================ */

.pandoc-widget {
    font-size: 0.95em; cursor: pointer; transition: all 0.2s ease; border-radius: 3px;
}

/* --- A. Figure Styles --- */
.pandoc-fig.pandoc-def {
    color: var(--pandoc-def-color);
    font-weight: var(--pandoc-def-weight);
    text-align: var(--pandoc-def-align);
    margin-top: var(--pandoc-def-offset);

    background-color: transparent; text-decoration: none; display: block; width: 100%;
    margin-bottom: -10px; padding: 0; line-height: 1.4;
}

.pandoc-fig.pandoc-ref {
    color: var(--pandoc-ref-color);
    font-weight: var(--pandoc-ref-weight);
    background-color: transparent; text-decoration: none; display: inline; text-align: left; width: auto; padding: 0 2px;
}
.pandoc-fig.pandoc-ref:hover {
    background-color: color-mix(in srgb, var(--pandoc-ref-color), transparent 90%);
    text-decoration: underline;
}

/* --- B. Table Styles --- */
.pandoc-tbl.pandoc-def {
    color: var(--pandoc-tbl-def-color);
    font-weight: var(--pandoc-tbl-def-weight);
    display: block; text-align: center; width: 100%;

    /* Variable Margin */
    margin-top: var(--pandoc-tbl-caption-offset, 0px) !important;
}

.pandoc-tbl.pandoc-ref {
    color: var(--pandoc-tbl-ref-color);
    font-weight: var(--pandoc-tbl-ref-weight);
    display: inline;
}
.pandoc-tbl.pandoc-ref:hover {
    background-color: color-mix(in srgb, var(--pandoc-tbl-ref-color), transparent 90%);
    text-decoration: underline;
}

/* Table Row Offset (Global Fix for Pandoc Empty Lines) */
.markdown-source-view.mod-cm6 .HyperMD-table-row-0 {
    margin-top: var(--pandoc-tbl-top-offset, -10px) !important;
}

/* Figure Empty Line Fix */
.cm-line:has(.pandoc-fig.pandoc-def) {
    margin-top: var(--pandoc-img-top-offset) !important;
    padding-top: 0 !important;
}

/* --- C. Integrity Check (Warnings) --- */
.pandoc-fig.pandoc-def.pandoc-error {
    color: var(--pandoc-error-color) !important;
}
.pandoc-fig.pandoc-ref.pandoc-error {
    color: var(--pandoc-error-color) !important;
    text-decoration: underline wavy var(--pandoc-error-color) !important;
    background-color: color-mix(in srgb, var(--pandoc-error-color), transparent 90%);
}

/* ============================================================
   SECTION 5: Figure Navigator (Sidebar)
   ============================================================ */

.pandoc-nav-container { padding: 10px; }

.pandoc-nav-item {
    display: block; padding: 6px 10px; margin-bottom: 4px;
    border-radius: 4px; cursor: pointer; font-size: var(--font-ui-small);
    transition: background-color 0.2s; line-height: 1.4;
}
.pandoc-nav-item:hover { background-color: var(--background-modifier-hover); }

.pandoc-nav-text { color: var(--text-normal); }
.pandoc-nav-item.is-orphan .pandoc-nav-text { color: var(--pandoc-error-color); }
